name: Promote Image to Stable

on:
  workflow_dispatch:
    inputs:
      source_tag:
        description: "Source image tag to promote (default: latest)"
        required: false
        default: "latest"
      selenium_version:
        description: "Selenium version (optional, for version tracking)"
        required: false

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Login to quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_ROBOT_TOKEN }}

      - name: Determine source tag
        id: source
        run: |
          SOURCE_TAG="${{ github.event.inputs.source_tag }}"
          if [ -z "$SOURCE_TAG" ]; then
            SOURCE_TAG="latest"
          fi
          echo "Source tag: $SOURCE_TAG"
          echo "tag=$SOURCE_TAG" >> $GITHUB_OUTPUT

      - name: Pull source image
        run: |
          echo "Pulling image: quay.io/rh_integration/selenium-standalone-chrome:${{ steps.source.outputs.tag }}"
          docker pull quay.io/rh_integration/selenium-standalone-chrome:${{ steps.source.outputs.tag }}

      - name: Inspect image for version
        id: version
        run: |
          # Try to get version from user input or image label
          if [ -n "${{ github.event.inputs.selenium_version }}" ]; then
            VERSION="${{ github.event.inputs.selenium_version }}"
          else
            # Try to extract from image label or use tag name
            VERSION=$(docker inspect quay.io/rh_integration/selenium-standalone-chrome:${{ steps.source.outputs.tag }} \
              --format '{{index .Config.Labels "org.opencontainers.image.version"}}' 2>/dev/null || echo "${{ steps.source.outputs.tag }}")
          fi

          echo "Detected version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Backup current stable version
        run: |
          CURRENT_STABLE=$(yq eval '.stable.version' .selenium-versions/versions.yaml)
          echo "Backing up current stable version: $CURRENT_STABLE"

          yq eval ".previous_stable.version = \"$CURRENT_STABLE\"" -i .selenium-versions/versions.yaml
          yq eval ".previous_stable.updated_at = \"$(date +%Y-%m-%d)\"" -i .selenium-versions/versions.yaml

      - name: Update stable version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Updating stable version to: $VERSION"

          yq eval ".stable.version = \"$VERSION\"" -i .selenium-versions/versions.yaml
          yq eval ".stable.updated_at = \"$(date +%Y-%m-%d)\"" -i .selenium-versions/versions.yaml

      - name: Re-tag and push as stable
        run: |
          # Create multi-arch stable tag from source (preserves both amd64 and arm64)
          docker buildx imagetools create \
            --tag quay.io/rh_integration/selenium-standalone-chrome:stable \
            quay.io/rh_integration/selenium-standalone-chrome:${{ steps.source.outputs.tag }}

      - name: Log deployment to history
        run: |
          # Update stable deployment info
          yq eval ".stable.selenium_version = \"${{ steps.version.outputs.version }}\"" -i .selenium-versions/deployment-log.yaml
          yq eval ".stable.deployed_at = \"$(date +%Y-%m-%d)\"" -i .selenium-versions/deployment-log.yaml
          yq eval ".stable.image_tag = \"stable\"" -i .selenium-versions/deployment-log.yaml

      - name: Commit version changes and deployment log
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .selenium-versions/versions.yaml .selenium-versions/deployment-log.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Promote ${{ steps.source.outputs.tag }} to stable (${{ steps.version.outputs.version }})"
            git push
          fi

      - name: Create git tag
        run: |
          TAG="stable-$(date +'%Y%m%d')"
          git tag -a "$TAG" -m "Promoted ${{ steps.source.outputs.tag }} to stable"
          git push origin "$TAG" || echo "Tag already exists or push failed"

      - name: Create summary
        run: |
          echo "## Image Promoted to Stable" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ“ Successfully Promoted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** \`${{ steps.source.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Tags" >> $GITHUB_STEP_SUMMARY
          echo "- \`quay.io/rh_integration/selenium-standalone-chrome:stable\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback" >> $GITHUB_STEP_SUMMARY
          echo "Previous stable version backed up to \`previous_stable\` in versions.yaml" >> $GITHUB_STEP_SUMMARY
